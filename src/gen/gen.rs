use crate::rng::Rng;
use crate::gen::{Limit, GenOnce};
use crate::gen::adapters::{MapGen, FlattenGen, FlatMapGen, DynGen, DynRcGen, DynArcGen};

/// Trait for generating random values of type `T`.
///
/// `Gen` trait represents a subset of `GenOnce`. It mirrors all methods of `GenOnce` without
/// the suffix `_once`. These methods must behave in the same way. For example an implementation
/// of `Gen` must produce the same value with its methods `gen` and `gen_once` if they are called
/// with the same `Rng` and `Limit`.
pub trait Gen<T>: GenOnce<T> {
    /// Generates a random value using.
    ///
    /// The `Rng` is the only source of the randomness. Besides that, the generation is
    /// derterministic.
    fn gen(&self, &mut Rng, Limit) -> T;

    /// Creates a new `Gen` by mapping the generated values of `self`.
    ///
    /// The function `f` will be applied to the generated values of `self`. These function results
    /// are the generated values of the new `Gen`.
    fn map<U, F>(self, f: F) -> MapGen<T, U, Self, F>
    where
        Self: Sized,
        F: Fn(T) -> U,
    {
        MapGen::new(self, f)
    }

    /// Creates a new `Gen` whose values are generated by the generated `Gen`s of `self`.
    fn flatten<U>(self) -> FlattenGen<U, T, Self>
    where
        Self: Sized,
        T: GenOnce<U>
    {
        FlattenGen::new(self)
    }

    /// Creates a new `Gen` similiar to `Gen::map`, except that the mapping produces `Gen`s.
    ///
    /// The function `f` will be applied to the generated values of `self`. These function results
    /// are `Gen`s that generates the values for the new `Gen`.
    ///
    /// It is semanticly equivalent to `self.map(f).flatten()`.
    fn flat_map<U, GU, F>(self, f: F) -> FlatMapGen<T, U, Self, GU, F>
    where
        Self: Sized,
        GU: GenOnce<U>,
        F: Fn(T) -> GU,
    {
        FlatMapGen::new(self, f)
    }

    /// Puts `self` behind a pointer.
    fn dyn<'a>(self) -> DynGen<'a, T>
    where
        Self: Sized + 'a,
    {
        DynGen::new(self)
    }

    /// Puts `self` behind an `Rc` pointer.
    fn dyn_rc<'a>(self) -> DynRcGen<'a, T>
    where
        Self: Sized + 'a,
    {
        DynRcGen::new(self)
    }

    /// Puts `self` behind an `Arc` pointer.
    fn dyn_arc(self) -> DynArcGen<T>
    where
        Self: Sized + 'static,
    {
        DynArcGen::new(self)
    }

    /// Calls `Gen::gen` with random seed and default parameters. Useful for debugging the
    /// generator.
    fn sample(&self) -> T {
        let mut rng = Rng::random();
        let lim = Limit::default();

        self.gen(&mut rng, lim)
    }
}

impl<T, F> Gen<T> for F
where
    F: Fn(&mut Rng, Limit) -> T,
{
    fn gen(&self, rng: &mut Rng, lim: Limit) -> T {
        self(rng, lim)
    }
}
